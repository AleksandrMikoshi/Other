# üõ°Ô∏è HAProxy VPN Gateway

## üìö –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [HAProxy](https://www.haproxy.org/) –≤–µ—Ä—Å–∏–∏ 3.2.4  
- –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ IP: [MaxMind GeoIP](https://www.maxmind.com/en/home)  
- –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ IP: [IPLists](https://iplists.firehol.org/)  

---
## ‚öôÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HAProxy —Å GeoIP –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –Ω–∞ [Habr](https://habr.com/ru/companies/vk/articles/502168) –æ—Ç VK.  
–û–¥–Ω–∞–∫–æ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **—á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ IP**, –∫–æ—Ç–æ—Ä–æ–º—É –¥–æ—Å—Ç—É–ø –∫ VPN —Å—Ç—Ä–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω.  

### ‚úÖ –ë–µ–ª—ã–π –∏ ‚ùå —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–∫–∏

- **–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫** ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é MaxMind GeoIP.  
- **–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫** ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ IPLists.  

–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç:  
[`update-haproxy-lists.sh`]() ‚Äî —Å–∫–∞—á–∏–≤–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —á–µ—Ä–Ω—ã–µ –∏ –±–µ–ª—ã–µ —Å–ø–∏—Å–∫–∏.

---
## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ HAProxy –ø–µ—Ä–µ–¥ VPN

HAProxy –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:  
1. ‚öñÔ∏è **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏** ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –º–µ–∂–¥—É VPN-–±—ç–∫–µ–Ω–¥–∞–º–∏.  
2. üîí **–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞** ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ –±–µ–ª–æ–º—É –∏ —á–µ—Ä–Ω–æ–º—É —Å–ø–∏—Å–∫–∞–º IP.  
3. üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å–∏—Å—Ç–µ–º—ã.  

### üìã –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª

–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ HAProxy –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ:  
```text
tcp-request connection reject if blacklist
tcp-request connection reject if !whitelist
```

- –ï—Å–ª–∏ IP –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ IP —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.
- –¢–∞–∫–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å IP –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –∏–ª–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤.

---
## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

–î–ª—è —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω —Å–∫—Ä–∏–ø—Ç - [active-ips-dashboard.py]()  

### üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GeoIP

–î–ª—è —Ä–∞–±–æ—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å geoipupdate:

```bash
sudo apt install geoipupdate
```

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∞–π–ª /etc/GeoIP.conf ([–ø—Ä–∏–º–µ—Ä]()) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

```bash
sudo geoipupdate
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ—è–≤–∏—Ç—Å—è —Ñ–∞–π–ª /var/lib/GeoIP/GeoLite2-Country.mmdb, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã –∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–ª–∞–≥–∞ –≤ —Ç–∞–±–ª–∏—Ü—É.

### üõ†Ô∏è –§—É–Ω–∫—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞

- –°–æ–∑–¥–∞–µ—Ç HTML-–¥–∞—à–±–æ—Ä–¥ —Å –¥–≤—É–º—è —Ç–∞–±–ª–∏—Ü–∞–º–∏:
    - –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç geoip2.database –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã –ø–æ IP

### üìä –û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ

- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- IP-–∞–¥—Ä–µ—Å
- –§—Ä–æ–Ω—Ç–µ–Ω–¥, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—ã—Ç–∞–ª–∏—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
- –¢–µ–∫—É—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –í—Å–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

---
## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏
[–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è HAProxy](https://www.haproxy.org/documentation/)
[GeoIP2 Python Library](https://pypi.org/project/geoip2/)
[IPLists](https://iplists.firehol.org/)

---
## üë§ –ê–≤—Ç–æ—Ä
**–ú–∏–∫–æ—à–∏ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä**  
–≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ **–ú2**